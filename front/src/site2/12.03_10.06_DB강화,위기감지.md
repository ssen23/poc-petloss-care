# 🎯 늘품 - 위기 감지 시스템 적용 가이드

## 📋 변경 사항 요약

### ✅ DB 필드 정리
```python
# ❌ 삭제
- emotional_temperature → emotional_score로 대체
- nicknames (PetMemory) → 삭제

# ✨ 변경
- emotional_temperature → emotional_score (1~10점, 명확한 기준)

# ✨ 추가
- consecutive_negative_count (연속 부정 횟수)

# ✅ 유지
- trigger_points (구체적 예시로 수집 개선)
- current_struggle
- social_support
- sensory_memories
- happy_moments
```

### ✨ 핵심 기능

1. **emotional_score (감정 점수)**
   - 1~3: 평온
   - 4~6: 약간의 슬픔
   - 7~8: 통제하기 힘든 슬픔 ⚠️
   - 9~10: 자해/자살 암시 🚨

2. **위기 감지 시스템**
   - 키워드 기반: "죽고 싶", "자살" 등
   - 점수 기반: emotional_score >= 9
   - 연속 기반: consecutive_negative_count >= 5

3. **3단계 대응**
   - Stable (안정): 일반 대화
   - Warning (경고): 전문가 상담 권장
   - Critical (위험): 즉각 위기상담 전화번호 제공

---

## 🚀 적용 방법

### Step 1: 백엔드

```bash
cd Test/backend/

# 백업
cp database.py database_backup_$(date +%Y%m%d).py
cp main.py main_backup_$(date +%Y%m%d).py

# 적용
cp database_최종정리.py database.py
cp main_위기감지_최종.py main.py

# ✨ 중요: DB 재생성 필요!
rm neulpoom_care.db
python database.py

# 재시작
python main.py
```

**예상 출력:**
```
✅ SQLite 데이터베이스(neulpoom_care.db)와 테이블 생성이 완료되었습니다!
📊 생성된 테이블:
   - users (사용자 기본 정보)
   - pets (반려동물 상세 정보)
   - diagnosis_results (위로 성향 진단 결과)
   - user_contexts (심리 상태 맥락) ✨ emotional_score 추가
   - pet_memories (감성 데이터) ✨ nicknames 삭제
   - conversations (대화 내역)
```

### Step 2: 프론트엔드 (선택)

위기 대응 UI를 추가하려면:

```bash
cd Test/front/src/site2/

# Screen3.jsx 열기
# Screen3_위기대응_UI추가.jsx 내용을 참고하여
# 메시지 렌더링 부분에 추가
```

**추가할 위치:**
```jsx
// NeulPoomScreen3.jsx의 messages.map() 안에

{messages.map((message, index) => (
  <div key={index}>
    {/* 기존 메시지 렌더링 */}
    <div className="bg-white rounded-2xl p-4">
      {message.text}
    </div>
    
    {/* ✨ 여기에 위기 알림 추가 */}
    {message.crisis_level === "critical" && (
      // Crisis UI 코드
    )}
  </div>
))}
```

---

## 🧪 테스트 시나리오

### Test 1: 일반 대화 (Stable)
```
User: "오늘 날씨 좋네요"

백엔드 로그:
✅ 정보 추출 성공: {"emotional_score": 3}
✅ UserContext.emotional_score 업데이트: 3/10

API 응답:
{
  "crisis_level": "stable",
  "emotional_score": 3
}
```

### Test 2: 슬픔 표현 (Stable → Warning)
```
대화 1-4: "너무 보고 싶어요" (emotional_score: 6)
대화 5: "계속 힘들어요" (emotional_score: 7)

백엔드 로그:
✅ UserContext.emotional_score 업데이트: 7/10
⚠️ 연속 부정 카운트: 1

대화 6-10: "너무 힘들어요" 반복

백엔드 로그:
⚠️ 연속 부정 카운트: 5
🔍 위기 감지: {'level': 'warning'}

API 응답:
{
  "crisis_level": "warning",
  "emotional_score": 7
}
```

### Test 3: 위기 키워드 (Critical)
```
User: "너무 힘들어서 죽고 싶어요"

백엔드 로그:
✅ 정보 추출 성공: {"emotional_score": 10}
🔍 위기 감지: {'level': 'critical'}

AI 응답:
"지금 정말 많이 힘드신 것 같아요. 
저보다는 전문가의 도움이 필요해 보여요.
혼자 견디지 마세요.
📞 자살예방상담: 1393 (24시간)
📞 정신건강위기: 1577-0199"

API 응답:
{
  "crisis_level": "critical",
  "crisis_alert": true,
  "emotional_score": 10
}
```

---

## 📊 작동 원리

### 1. 정보 추출 (extract_and_analyze_emotion)
```python
User: "너무 힘들어서 밥그릇 치울 때마다 울어요"
    ↓
GPT 분석:
{
  "emotional_score": 7,
  "trigger_point": "밥그릇 치울 때",
  "current_struggle": "그리움"
}
    ↓
DB 업데이트:
- emotional_score = 7
- trigger_points = ["밥그릇 치울 때"]
- consecutive_negative_count = 1
```

### 2. 위기 감지 (detect_crisis)
```python
입력:
- user_message: "죽고 싶어요"
- emotional_score: 10
- consecutive_count: 5

검사:
1. 키워드 체크: "죽고 싶" in message → True
2. 점수 체크: 10 >= 9 → True
3. 연속 체크: 5 >= 5 → True

결과:
{
  "level": "critical",
  "action": "emergency_resources"
}
```

### 3. 시스템 프롬프트 변경
```python
if crisis_mode:
    system_prompt = """
    🚨 [긴급 모드]
    사용자가 위험 신호를 보이고 있습니다.
    전문가 도움을 받도록 유도하세요.
    답변 끝에 반드시 전문 상담 센터 안내 포함.
    """
else:
    system_prompt = """
    일반 위로 모드
    """
```

---

## 🔍 API 응답 구조 변경

### Before (기존)
```json
{
  "reply": "많이 힘드시겠어요...",
  "persona": "LISTENER"
}
```

### After (신규)
```json
{
  "reply": "많이 힘드시겠어요...",
  "persona": "LISTENER",
  "crisis_level": "warning",      // ✨ 추가
  "crisis_alert": false,           // ✨ 추가
  "emotional_score": 7             // ✨ 추가
}
```

---

## 💡 핵심 포인트

### ✅ emotional_temperature → emotional_score
**Before:**
```python
emotional_temperature = 5  # 고정, 의미 없음
```

**After:**
```python
emotional_score = 7  # 매 대화마다 업데이트, 명확한 기준
# 1~3: 평온
# 4~6: 슬픔
# 7~8: 심각 ⚠️
# 9~10: 위험 🚨
```

### ✅ trigger_points 수집 개선
**Before:**
```python
extraction_prompt = "트리거 포인트를 찾으세요"
# 결과: null (추출 안 됨)
```

**After:**
```python
extraction_prompt = """
trigger_point: 슬픔을 유발한 구체적 대상/상황
예시: "밥그릇 치울 때", "산책로 지날 때", "밤 10시만 되면"
"""
# 결과: "밥그릇 치울 때" ✅
```

### ✅ 위기 감지 3단계
```
Stable (emotional_score 1~6, 연속 <5)
→ 일반 대화

Warning (emotional_score 7~8 또는 연속 ≥5)
→ "전문가 상담 권장" 메시지

Critical (emotional_score ≥9 또는 위험 키워드)
→ 즉각 위기상담 전화번호 제공
```

---

## ⚠️ 주의사항

### 1. DB 재생성 필수
```bash
# 반드시 실행!
rm neulpoom_care.db
python database.py
```

**이유:** 
- emotional_temperature → emotional_score 변경
- consecutive_negative_count 필드 추가
- nicknames 필드 삭제

### 2. 기존 데이터 백업
```bash
# 기존 DB 백업 (선택)
cp neulpoom_care.db neulpoom_care_backup_$(date +%Y%m%d).db
```

### 3. 프론트엔드 대응
프론트엔드에서 `crisis_level`, `crisis_alert` 필드를 받아 처리:

```jsx
const response = await fetch('/api/chat', {...});
const data = await response.json();

if (data.crisis_alert) {
  // 위기 알림 UI 표시
  showCrisisAlert(data.crisis_level);
}
```

---

## 🎯 기대 효과

### Before (기존)
```
User: "죽고 싶어요" (10번 반복)
    ↓
AI: "힘드시겠어요. 천천히 말씀해 주세요." (계속 반복)
    ↓
❌ 위험 상황 인지 못함
❌ 전문가 연결 없음
```

### After (개선)
```
User: "죽고 싶어요"
    ↓
emotional_score = 10
crisis_level = "critical"
    ↓
AI: "지금 많이 힘드신 것 같아요. 
     전문가의 도움이 필요해 보여요.
     📞 자살예방상담: 1393"
    ↓
✅ 위험 상황 즉시 감지
✅ 전문가 연결 유도
```

---

## 📦 생성된 파일

1. **[database_최종정리.py](computer:///mnt/user-data/outputs/database_최종정리.py)**
   - emotional_score 변경
   - nicknames 삭제
   - consecutive_negative_count 추가

2. **[main_위기감지_최종.py](computer:///mnt/user-data/outputs/main_위기감지_최종.py)**
   - extract_and_analyze_emotion() 함수
   - detect_crisis() 함수
   - 위기 모드 시스템 프롬프트

3. **[Screen3_위기대응_UI추가.jsx](computer:///mnt/user-data/outputs/Screen3_위기대응_UI추가.jsx)**
   - Critical/Warning UI 컴포넌트

4. **[적용가이드_위기감지.md](computer:///mnt/user-data/outputs/적용가이드_위기감지.md)**
   - 이 문서

---

## ✅ 체크리스트

- [ ] database.py 백업
- [ ] main.py 백업
- [ ] neulpoom_care.db 삭제
- [ ] database_최종정리.py → database.py 복사
- [ ] main_위기감지_최종.py → main.py 복사
- [ ] python database.py 실행
- [ ] python main.py 실행
- [ ] 테스트: 일반 대화 (emotional_score 확인)
- [ ] 테스트: 위험 키워드 (crisis_level 확인)
- [ ] 테스트: API 응답 구조 확인
- [ ] (선택) 프론트엔드 UI 추가

---

## 🎉 완료!

이제 늘품은:
- ✅ emotional_score로 감정 상태 실시간 추적
- ✅ trigger_points 정확하게 수집
- ✅ 위기 상황 자동 감지
- ✅ 3단계 대응 시스템

**간단하고 효과적인 위기 감지 시스템이 완성되었습니다!** 😊
