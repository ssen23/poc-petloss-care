# ğŸš€ ëŠ˜í’ˆ RAG êµ¬ì¡° ê°œí¸ ìµœì¢… ì ìš© ê°€ì´ë“œ

## ğŸ“¦ ìƒì„±ëœ íŒŒì¼ ëª©ë¡

### âœ… ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼ (7ê°œ)

| íŒŒì¼ëª… | ìœ„ì¹˜ | ì„¤ëª… |
|--------|------|------|
| `clinical_protocol_master.md` | `data/01_core_logic/` | ìƒë‹´ í”„ë¡œí† ì½œ (CHUNK 1~12) |
| `persona_guidelines.md` | `data/01_core_logic/` | 5ê°€ì§€ í˜ë¥´ì†Œë‚˜ ê°€ì´ë“œ |
| `disease_encyclopedia.md` | `data/02_domain_knowledge/` | ì§ˆë³‘ ë°±ê³¼ (ì‹ ë¶€ì „, ì‹¬ì¥ë³‘, ì•”) |
| `emergency_hotlines.json` | `data/03_structured_data/` | ìœ„ê¸° ìƒë‹´ í•«ë¼ì¸ 8ê°œ |
| `system_persona.txt` | `prompts/` | LLM ì¸ê²© ì„¤ì • |
| `rag_engine.py` | `src/` | RAG ê²€ìƒ‰ ì—”ì§„ |
| `RAG_êµ¬ì¡°ê°œí¸_ì™„ì „ê°€ì´ë“œ.md` | `outputs/` | ì „ì²´ ê°€ì´ë“œ ë¬¸ì„œ |

---

## ğŸ”§ Step 1: í´ë” êµ¬ì¡° ë§Œë“¤ê¸° (5ë¶„)

```bash
cd Test/back/

# 1. ë°ì´í„° í´ë” ìƒì„±
mkdir -p data/01_core_logic
mkdir -p data/02_domain_knowledge
mkdir -p data/03_structured_data

# 2. í”„ë¡¬í”„íŠ¸ í´ë” ìƒì„±
mkdir -p prompts

# 3. ì†ŒìŠ¤ ì½”ë“œ í´ë” ìƒì„±
mkdir -p src
```

### í™•ì¸
```bash
tree -L 2
```

**ì˜ˆìƒ ê²°ê³¼**:
```
Test/back/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ 01_core_logic/
â”‚   â”œâ”€â”€ 02_domain_knowledge/
â”‚   â””â”€â”€ 03_structured_data/
â”œâ”€â”€ prompts/
â”œâ”€â”€ src/
â”œâ”€â”€ main.py
â”œâ”€â”€ database.py
â””â”€â”€ .env
```

---

## ğŸ“ Step 2: íŒŒì¼ ë°°ì¹˜ (20ë¶„)

### 2-1. Core Logic (ìƒë‹´ í”„ë¡œí† ì½œ)

```bash
cd Test/back/data/01_core_logic/

# íŒŒì¼ ë³µì‚¬ (ë‹¤ìš´ë¡œë“œ í´ë”ì—ì„œ)
cp ~/Downloads/data_clinical_protocol_master.md ./clinical_protocol_master.md
cp ~/Downloads/data_persona_guidelines.md ./persona_guidelines.md
```

### 2-2. Domain Knowledge (ì§ˆë³‘ ë°±ê³¼)

```bash
cd Test/back/data/02_domain_knowledge/

cp ~/Downloads/data_disease_encyclopedia.md ./disease_encyclopedia.md
```

### 2-3. Structured Data (JSON)

```bash
cd Test/back/data/03_structured_data/

cp ~/Downloads/data_emergency_hotlines.json ./emergency_hotlines.json
```

### 2-4. Prompts (ì‹œìŠ¤í…œ í˜ë¥´ì†Œë‚˜)

```bash
cd Test/back/prompts/

cp ~/Downloads/prompts_system_persona.txt ./system_persona.txt
```

### 2-5. RAG ì—”ì§„

```bash
cd Test/back/src/

cp ~/Downloads/src_rag_engine.py ./rag_engine.py
```

---

## ğŸ”Œ Step 3: main.py ì—…ê·¸ë ˆì´ë“œ (30ë¶„)

### 3-1. RAG ì—”ì§„ ì„í¬íŠ¸ ì¶”ê°€

`main.py` ìƒë‹¨ì— ì¶”ê°€:

```python
# ê¸°ì¡´ ì„í¬íŠ¸ ì•„ë˜ì— ì¶”ê°€
from src.rag_engine import NeulPoomRAG

# RAG ì—”ì§„ ì´ˆê¸°í™” (app ìƒì„± í›„)
rag = NeulPoomRAG(data_dir="./data")
```

### 3-2. /api/chat ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

**Before**:
```python
@app.post("/api/chat")
async def chat(request: ChatRequest, db: Session = Depends(get_db)):
    # ... ê¸°ì¡´ ì½”ë“œ ...
    
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    system_prompt = build_system_prompt_with_rag(
        ...,
        retrieved_knowledge=retrieved_knowledge  # knowledge_base.py ì‚¬ìš©
    )
```

**After**:
```python
@app.post("/api/chat")
async def chat(request: ChatRequest, db: Session = Depends(get_db)):
    # ... ê¸°ì¡´ ì½”ë“œ ...
    
    # âœ¨ RAG ê²€ìƒ‰ ì¶”ê°€
    rag_results = rag.search(
        query=request.message,
        intent="auto",
        max_results=2
    )
    
    # âœ¨ LLMìš© ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    rag_context = rag.get_context_for_llm(rag_results)
    
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— í†µí•©
    system_prompt = build_system_prompt_with_rag_v2(
        guardian_name=user.nickname,
        pet_name=pet.pet_name,
        ...,
        rag_context=rag_context  # RAG ê²€ìƒ‰ ê²°ê³¼ ì£¼ì…
    )
```

### 3-3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í•¨ìˆ˜ ìˆ˜ì •

**ìƒˆë¡œìš´ í•¨ìˆ˜ ì¶”ê°€**:
```python
def build_system_prompt_with_rag_v2(
    guardian_name: str,
    pet_name: str,
    care_status: str,
    years_together: str,
    persona_type: str,
    user_context: Optional[UserContext],
    pet_memory: Optional[PetMemory],
    rag_context: str  # âœ¨ ìƒˆë¡œ ì¶”ê°€
) -> str:
    """
    RAG ê²€ìƒ‰ ê²°ê³¼ë¥¼ í¬í•¨í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    """
    
    # ê¸°ë³¸ í˜ë¥´ì†Œë‚˜ ì„¤ì • ë¡œë“œ
    with open("./prompts/system_persona.txt", "r", encoding="utf-8") as f:
        base_persona = f.read()
    
    # í˜ë¥´ì†Œë‚˜ë³„ ê°€ì´ë“œë¼ì¸ ë¡œë“œ
    persona_guide = {
        "LISTENER": "ë°˜ì˜(Reflection), íƒ€ë‹¹í™”(Validation)",
        "MENTOR": "ëª…ë£Œí™”(Clarification), ì‹¬ë¦¬êµìœ¡",
        "PARTNER": "í˜‘ë ¥ì  ê²½í—˜ì£¼ì˜",
        "GUARDIAN": "ì¬ë³´ì¦(Reassurance), ìê¸°ì—°ë¯¼",
        "OBSERVER": "ì•ˆì „ ê¸°ì§€(Secure Base)"
    }
    
    # ê°ì • ì˜¨ë„
    emotion_score = user_context.emotional_score if user_context else 5
    tone = "ì°¨ë¶„" if emotion_score <= 3 else "ê³µê°ì " if emotion_score <= 6 else "ì¡°ì‹¬ìŠ¤ëŸ½ê³  ì§€ì§€ì "
    
    # ë§¥ë½ ì •ë³´
    context_info = ""
    if user_context:
        if user_context.current_struggle:
            context_info += f"- í˜¸ì†Œ ë¬¸ì œ: {user_context.current_struggle}\n"
        if user_context.trigger_points:
            triggers = json.loads(user_context.trigger_points)
            if triggers:
                context_info += f"- ì£¼ì˜ íŠ¸ë¦¬ê±°: {', '.join(triggers)}\n"
    
    # ìµœì¢… í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
    return f"""
{base_persona}

**ë‚´ë‹´ì ì •ë³´:**
- ë³´í˜¸ì: {guardian_name}
- ë°˜ë ¤ë™ë¬¼: {pet_name} ({care_status}, í•¨ê»˜í•œ ì‹œê°„: {years_together})

**í˜„ì¬ ì„¤ì •:**
- í˜ë¥´ì†Œë‚˜: {persona_type}
- ê°ì • ì˜¨ë„: {emotion_score}/10
- ë§íˆ¬: {tone}
- ìƒë‹´ ê¸°ë²•: {persona_guide.get(persona_type)}

**ë‚´ë‹´ì ë§¥ë½:**
{context_info}

**[RAG ê²€ìƒ‰ ê²°ê³¼ - ì°¸ê³ ìš©]**
{rag_context}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë‚´ë‹´ìì—ê²Œ ê°€ì¥ ì ì ˆí•œ ë‹µë³€ì„ ìƒì„±í•˜ì„¸ìš”.
"""
```

---

## ğŸ§ª Step 4: í…ŒìŠ¤íŠ¸ (10ë¶„)

### 4-1. RAG ì—”ì§„ ë‹¨ë… í…ŒìŠ¤íŠ¸

```bash
cd Test/back/
python src/rag_engine.py
```

**ì˜ˆìƒ ì¶œë ¥**:
```
ğŸ”„ RAG ë°ì´í„° ë¡œë”© ì¤‘...
âœ… Core Logic: 2ê°œ íŒŒì¼
âœ… Domain Knowledge: 1ê°œ íŒŒì¼
âœ… Structured Data: 1ê°œ íŒŒì¼
âœ… RAG ë°ì´í„° ë¡œë”© ì™„ë£Œ!

============================================================
Query: ë„ˆë¬´ ìŠ¬í¼ìš”
============================================================
Detected Intent: emotional
Core Logic: 2 results
Domain Knowledge: 0 results
Structured Data: 0 results

[LLM Context Preview]
[ìƒë‹´ í”„ë¡œí† ì½œ ê°€ì´ë“œë¼ì¸]

CHUNK 1:
...
```

### 4-2. ì„œë²„ ì‹¤í–‰ í…ŒìŠ¤íŠ¸

```bash
python main.py
```

**í™•ì¸ ì‚¬í•­**:
- âœ… RAG ë°ì´í„° ë¡œë”© ë©”ì‹œì§€ ì¶œë ¥
- âœ… ì—ëŸ¬ ì—†ì´ ì„œë²„ ì‹œì‘
- âœ… http://localhost:8000 ì ‘ì† ê°€ëŠ¥

### 4-3. ì±„íŒ… í…ŒìŠ¤íŠ¸

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í…ŒìŠ¤íŠ¸:

**ì¼€ì´ìŠ¤ 1 (ê°ì •)**:
```
ì‚¬ìš©ì: "ë„ˆë¬´ ìŠ¬í¼ìš”"
â†’ ì˜ˆìƒ: Core Logicì—ì„œ PSY_VALIDATION ì²­í¬ ê²€ìƒ‰
â†’ ì‘ë‹µ: íƒ€ë‹¹í™” ë©”ì‹œì§€
```

**ì¼€ì´ìŠ¤ 2 (ì •ë³´)**:
```
ì‚¬ìš©ì: "ì‹ ë¶€ì „ ì¦ìƒì´ ê¶ê¸ˆí•´ìš”"
â†’ ì˜ˆìƒ: Domain Knowledgeì—ì„œ disease_encyclopedia ê²€ìƒ‰
â†’ ì‘ë‹µ: ì‹ ë¶€ì „ ì¦ìƒ ì„¤ëª…
```

**ì¼€ì´ìŠ¤ 3 (ì„œë¹„ìŠ¤)**:
```
ì‚¬ìš©ì: "í˜ë“¤ì–´ìš”. ìƒë‹´ ì „í™” ì•Œë ¤ì£¼ì„¸ìš”"
â†’ ì˜ˆìƒ: Structured Dataì—ì„œ emergency_hotlines ê²€ìƒ‰
â†’ ì‘ë‹µ: 1577-0199, 1393 ì•ˆë‚´
```

---

## ğŸ“ˆ Step 5: ë°ì´í„° ì ì§„ì  ì¶”ê°€ (1ì£¼ì¼)

### ì¶”ê°€í•  íŒŒì¼ ëª©ë¡ (ìš°ì„ ìˆœìœ„ë³„)

#### ğŸ”¥ Priority 2 (ì´ë²ˆ ì£¼)
- [ ] `legal_guide.md` (ë™ë¬¼ë“±ë¡ ë§ì†Œ, ë³´í—˜)
- [ ] `funeral_homes.json` (ì¥ë¡€ì‹ì¥ 20ê³³)

#### âš¡ Priority 3 (ë‹¤ìŒ ì£¼)
- [ ] `grief_theory.md` (ì• ë„ ì´ë¡ )
- [ ] `counseling_centers.json` (ìƒë‹´ì„¼í„°)
- [ ] `recommended_books.md` (ë„ì„œ ì¶”ì²œ)

#### ğŸ“Œ Priority 4 (ì¶”í›„)
- [ ] `disease_encyclopedia.md` í™•ì¥ (ë‹¹ë‡¨, ê°„ì§ˆí™˜ ë“± 5ê°œ ì¶”ê°€)
- [ ] `ritual_guide.md` (ì¶”ëª¨ ì˜ì‹ ê°€ì´ë“œ)

---

## ğŸ¯ ë°ì´í„° ìˆ˜ì§‘ ë°©ë²• (ì‹¤ì „)

### ë°©ë²• 1: legal_guide.md (1ì‹œê°„)

**Step 1**: ì •ë¶€24 ì ‘ì†
```
https://www.gov.kr
ê²€ìƒ‰: "ë°˜ë ¤ë™ë¬¼ ì‚¬ë§ ì‹ ê³ "
```

**Step 2**: ì •ë¦¬
```markdown
# ë°˜ë ¤ë™ë¬¼ ì‚¬ë§ ì‹œ í–‰ì • ì ˆì°¨

## ë™ë¬¼ë“±ë¡ ë§ì†Œ ì‹ ê³ 

### ì‹ ê³  ê¸°í•œ
- ì‚¬ë§ í›„ **30ì¼ ì´ë‚´**
- ì§€ìì²´ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ

### ì‹ ê³  ë°©ë²•
1. ì˜¨ë¼ì¸: ë™ë¬¼ë³´í˜¸ê´€ë¦¬ì‹œìŠ¤í…œ (https://www.animal.go.kr)
2. ì˜¤í”„ë¼ì¸: ê´€í•  êµ¬ì²­ ë°©ë¬¸

### í•„ìš” ì„œë¥˜
- ë™ë¬¼ë“±ë¡ì¦
- ì‚¬ë§ í™•ì¸ì„œ (ë™ë¬¼ë³‘ì› ë°œê¸‰)
- ë³´í˜¸ì ì‹ ë¶„ì¦

### ê³¼íƒœë£Œ
- 30ì¼ ê²½ê³¼ ì‹œ 5ë§Œì› ~ 10ë§Œì›
- ì§€ìì²´ë³„ ìƒì´

[ì¶œì²˜: ë™ë¬¼ë³´í˜¸ë²• ì‹œí–‰ê·œì¹™ ì œ12ì¡°]
```

### ë°©ë²• 2: funeral_homes.json (3ì‹œê°„)

**Step 1**: ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰
```
ê²€ìƒ‰ì–´: "ë°˜ë ¤ë™ë¬¼ ì¥ë¡€ì‹ì¥"
í•„í„°: í‰ì  4.5 ì´ìƒ
```

**Step 2**: ì •ë³´ ìˆ˜ì§‘ (ì—‘ì…€)
| ì´ë¦„ | ì£¼ì†Œ | ì „í™” | í‰ì  | ë¦¬ë·° | ê°€ê²© |
|------|------|------|------|------|------|
| 21ê·¸ë¨ ê°•ë‚¨ì  | ... | ... | 4.8 | 234 | 300,000 |

**Step 3**: JSON ë³€í™˜
```json
[
  {
    "id": "funeral_001",
    "name": "21ê·¸ë¨ ê°•ë‚¨ì ",
    ...
  }
]
```

---

## ğŸ› ï¸ ê³ ê¸‰ ê¸°ëŠ¥ (ì¶”í›„ ì—…ê·¸ë ˆì´ë“œ)

### 1. ë²¡í„° ì„ë² ë”© (Semantic Search)

í˜„ì¬ëŠ” í‚¤ì›Œë“œ ë§¤ì¹­ì´ì§€ë§Œ, ë‚˜ì¤‘ì— ì„ë² ë”©ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥:

```python
# pip install sentence-transformers
from sentence_transformers import SentenceTransformer

model = SentenceTransformer('sentence-transformers/xlm-r-100langs-bert-base-nli-stsb-mean-tokens')

# ì²­í¬ ì„ë² ë”©
embeddings = model.encode(chunks)

# ê²€ìƒ‰ ì‹œ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
query_embedding = model.encode(query)
scores = cosine_similarity(query_embedding, embeddings)
```

### 2. í¬ë¡¤ë§ ìë™í™”

```python
# funeral_crawler.py
from selenium import webdriver
# ë„¤ì´ë²„ ì§€ë„ ìë™ í¬ë¡¤ë§...
```

### 3. ëŒ€í™” íˆìŠ¤í† ë¦¬ ê¸°ë°˜ ê²€ìƒ‰

```python
# ì´ì „ ëŒ€í™” ë§¥ë½ì„ ê³ ë ¤í•œ ê²€ìƒ‰
def search_with_history(query, conversation_history):
    # ìµœê·¼ 3í„´ì˜ ëŒ€í™”ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
    context_keywords = extract_keywords(conversation_history[-3:])
    # í˜„ì¬ query + ë§¥ë½ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
    ...
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í´ë” êµ¬ì¡° ìƒì„± ì™„ë£Œ
- [ ] 7ê°œ íŒŒì¼ ë°°ì¹˜ ì™„ë£Œ
- [ ] RAG ì—”ì§„ ë‹¨ë… í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] main.py ìˆ˜ì • ì™„ë£Œ
- [ ] ì„œë²„ ì‹¤í–‰ ì„±ê³µ
- [ ] ì±„íŒ… í…ŒìŠ¤íŠ¸ (ê°ì •) ì„±ê³µ
- [ ] ì±„íŒ… í…ŒìŠ¤íŠ¸ (ì •ë³´) ì„±ê³µ
- [ ] ì±„íŒ… í…ŒìŠ¤íŠ¸ (ì„œë¹„ìŠ¤) ì„±ê³µ

---

## ğŸ‰ ì™„ë£Œ!

ì´ì œ ëŠ˜í’ˆì€:
- âœ… ìƒë‹´ í”„ë¡œí† ì½œ (CHUNK 1~12)
- âœ… í˜ë¥´ì†Œë‚˜ ê°€ì´ë“œ (L/M/P/O/G)
- âœ… ì§ˆë³‘ ë°±ê³¼ (ì‹ ë¶€ì „, ì‹¬ì¥ë³‘, ì•”)
- âœ… ìœ„ê¸° í•«ë¼ì¸ (8ê°œ)
- âœ… RAG ê²€ìƒ‰ ì—”ì§„

ì„ ëª¨ë‘ ê°–ì¶˜ **Production-Level í«ë¡œìŠ¤ ì „ë¬¸ AI**ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ¿

---

## ğŸ“ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: "No module named 'src.rag_engine'"
**í•´ê²°**: `src/` í´ë”ì— `__init__.py` ì¶”ê°€
```bash
touch src/__init__.py
```

### ë¬¸ì œ 2: RAG ë°ì´í„° ë¡œë”© ì‹¤íŒ¨
**í•´ê²°**: íŒŒì¼ ê²½ë¡œ í™•ì¸
```bash
ls data/01_core_logic/
ls data/02_domain_knowledge/
ls data/03_structured_data/
```

### ë¬¸ì œ 3: í•œê¸€ ê¹¨ì§
**í•´ê²°**: íŒŒì¼ ì¸ì½”ë”© í™•ì¸ (UTF-8ë¡œ ì €ì¥)

---

ë‹¤ìŒ ë‹¨ê³„: **ë°ì´í„° ì ì§„ì  í™•ì¥** ğŸš€
